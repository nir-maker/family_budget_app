import { useState, useEffect } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Table, TableHead, TableRow, TableCell, TableBody } from "@/components/ui/table";
import { Line } from "react-chartjs-2";
import { Chart as ChartJS, CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend, Filler } from "chart.js";

// Ensure CategoryScale is registered
ChartJS.register(CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend, Filler);

export default function BudgetApp() {
  const [transactions, setTransactions] = useState(() => {
    const savedTransactions = localStorage.getItem("transactions");
    return savedTransactions ? JSON.parse(savedTransactions) : [];
  });
  const [amount, setAmount] = useState("");
  const [description, setDescription] = useState("");
  const [type, setType] = useState("income");
  const [balanceLimit, setBalanceLimit] = useState(-500);

  useEffect(() => {
    localStorage.setItem("transactions", JSON.stringify(transactions));
  }, [transactions]);

  const totalBalance = transactions.reduce((acc, t) => acc + t.amount, 0);

  useEffect(() => {
    if (totalBalance < balanceLimit) {
      sendAlert();
    }
  }, [totalBalance]);

  const sendAlert = () => {
    const alertData = { message: "אזהרה! אתם בחריגה מהתקציב!", phoneNumber: "0508356542" };
    console.log("Sending alert with data:", alertData);
  };

  const addTransaction = () => {
    if (!amount || !description) return;
    const newTransaction = {
      id: Date.now(),
      description,
      amount: type === "income" ? parseFloat(amount) : -parseFloat(amount),
      date: new Date().toISOString().slice(0, 7), // Store year-month format
    };
    setTransactions([...transactions, newTransaction]);
    setAmount("");
    setDescription("");
  };

  const chartData = {
    labels: transactions.map((_, index) => `תנועה ${index + 1}`),
    datasets: [
      {
        label: "יתרה",
        data: transactions.reduce((acc, t) => {
          acc.push((acc[acc.length - 1] || 0) + t.amount);
          return acc;
        }, []),
        borderColor: "#2563eb",
        backgroundColor: "rgba(37, 99, 235, 0.2)",
        fill: true,
      },
    ],
  };

  const monthlySummaries = transactions.reduce((summary, transaction) => {
    if (!summary[transaction.date]) {
      summary[transaction.date] = { income: 0, expense: 0 };
    }
    if (transaction.amount > 0) {
      summary[transaction.date].income += transaction.amount;
    } else {
      summary[transaction.date].expense += Math.abs(transaction.amount);
    }
    return summary;
  }, {});

  return (
    <div className="max-w-lg mx-auto mt-10 p-4 bg-gray-100 rounded-lg shadow-md md:max-w-2xl">
      <h1 className="text-2xl font-bold text-center mb-4 text-blue-600">ניהול תקציב משפחתי</h1>
      <Card className="p-4 mb-4 bg-white rounded-lg shadow">
        <CardContent>
          <h2 className="text-lg font-semibold text-gray-700">יתרה נוכחית: {totalBalance.toFixed(2)} ₪</h2>
        </CardContent>
      </Card>
      <Card className="p-4 mb-4 bg-white rounded-lg shadow">
        <CardContent>
          <h2 className="text-lg font-semibold mb-2 text-gray-700">גרף יתרה</h2>
          <Line data={chartData} options={{ responsive: true, maintainAspectRatio: false }} />
        </CardContent>
      </Card>
      <Card className="p-4 mb-4 bg-white rounded-lg shadow">
        <CardContent>
          <h2 className="text-lg font-semibold mb-2 text-gray-700">סיכומים חודשיים</h2>
          <Table className="w-full border rounded-lg">
            <TableHead>
              <TableRow className="bg-gray-200">
                <TableCell className="p-2">חודש</TableCell>
                <TableCell className="p-2">סה"כ הכנסות</TableCell>
                <TableCell className="p-2">סה"כ הוצאות</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {Object.keys(monthlySummaries).map((month) => (
                <TableRow key={month} className="border-b">
                  <TableCell className="p-2">{month}</TableCell>
                  <TableCell className="p-2 text-green-500">{monthlySummaries[month].income.toFixed(2)} ₪</TableCell>
                  <TableCell className="p-2 text-red-500">{monthlySummaries[month].expense.toFixed(2)} ₪</TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
      <Card className="p-4 mb-4 bg-white rounded-lg shadow">
        <CardContent>
          <h2 className="text-lg font-semibold mb-2 text-gray-700">הוספת תנועה</h2>
          <div className="flex flex-col gap-2 md:flex-row">
            <Input type="number" placeholder="סכום" value={amount} onChange={(e) => setAmount(e.target.value)} className="p-2 border rounded" />
            <Input type="text" placeholder="תיאור" value={description} onChange={(e) => setDescription(e.target.value)} className="p-2 border rounded" />
            <select value={type} onChange={(e) => setType(e.target.value)} className="p-2 border rounded">
              <option value="income">הכנסה</option>
              <option value="expense">הוצאה</option>
            </select>
            <Button className="bg-blue-500 text-white rounded p-2" onClick={addTransaction}>הוסף</Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
